---
phase: 08-compatibility-matrix-evidence-automation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/update-compat-matrix.sh
  - scripts/update_compat_matrix.py
  - .planning/compatibility/v1.1-matrix.md
autonomous: true
requirements:
  - COMP-03
user_setup: []
must_haves:
  truths:
    - Matrix updates are generated from observed wrapper evidence (`./scripts/verify-suite.sh --json`) only.
    - Matrix row identity is keyed by `Environment Profile` + `Check Scope` and updates are deterministic.
    - Matrix schema fields and status vocabulary (`PASS`/`SKIP`/`FAIL`) are strictly enforced.
    - Invalid evidence input or schema mismatch fails fast without silent matrix rewrites.
  artifacts:
    - scripts/update-compat-matrix.sh
    - scripts/update_compat_matrix.py
    - .planning/compatibility/v1.1-matrix.md
  key_links:
    - scripts/update-compat-matrix.sh:CLI entrypoint -> non-interactive evidence ingestion contract
    - scripts/update_compat_matrix.py:row-key update engine -> deterministic update/insert behavior
    - scripts/update_compat_matrix.py:schema/status validators -> fail-fast guardrails
    - .planning/compatibility/v1.1-matrix.md:canonical target -> required row schema preserved
---

<objective>
Implement the Phase 8 evidence-ingestion and matrix-update automation flow for `COMP-03`.

Purpose: allow maintainers to update canonical compatibility rows from observed wrapper JSON evidence with strict schema/provenance guardrails.
Output: deterministic matrix update tooling and canonical matrix updates at `.planning/compatibility/v1.1-matrix.md`.
</objective>

<execution_context>
@/Users/maleick/.codex/get-shit-done/workflows/execute-plan.md
@/Users/maleick/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-compatibility-matrix-evidence-automation/08-CONTEXT.md
@.planning/phases/08-compatibility-matrix-evidence-automation/08-RESEARCH.md
@.planning/compatibility/v1.1-matrix.md
@scripts/verify-suite.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build deterministic matrix update entrypoint and key-based update engine</name>
  <files>scripts/update-compat-matrix.sh,scripts/update_compat_matrix.py</files>
  <action>Create a non-interactive CLI wrapper (`scripts/update-compat-matrix.sh`) and a deterministic Python update engine (`scripts/update_compat_matrix.py`). Parse observed wrapper JSON evidence (`./scripts/verify-suite.sh --json` output), derive row status under evidence-only rules, and update or insert row keys by exact `Environment Profile` + `Check Scope` match.</action>
  <verify>bash -n scripts/update-compat-matrix.sh && python3 scripts/update_compat_matrix.py --help >/dev/null && tmp_matrix="$(mktemp)" && cp .planning/compatibility/v1.1-matrix.md "$tmp_matrix" && tmp_evidence="$(mktemp)" && ./scripts/verify-suite.sh --json >"$tmp_evidence" && ./scripts/update-compat-matrix.sh --matrix "$tmp_matrix" --evidence "$tmp_evidence" --env-profile "macOS (Darwin arm64, current host)" --check-scope "install/shell/tmux/vim/docs parity" --caveat "host-specific observed run" --command-ref "./scripts/verify-suite.sh --json" --date 2026-02-25 && rg -n "macOS \(Darwin arm64, current host\)|install/shell/tmux/vim/docs parity|PASS|FAIL|SKIP" "$tmp_matrix"</verify>
  <done>Automation can update an existing row deterministically from observed evidence with stable key matching.</done>
</task>

<task type="auto">
  <name>Task 2: Enforce schema/status/provenance guards and malformed-input rejection</name>
  <files>scripts/update_compat_matrix.py,.planning/compatibility/v1.1-matrix.md</files>
  <action>Enforce required matrix columns (`Environment Profile`, `Check Scope`, `Status`, `Caveat`, `Command Set Reference`, `Last Validated`), status vocabulary (`PASS`/`SKIP`/`FAIL`), and provenance/date requirements. Ensure missing/invalid evidence and schema mismatches fail fast with actionable messages and non-zero exit.</action>
  <verify>tmp_matrix="$(mktemp)" && cp .planning/compatibility/v1.1-matrix.md "$tmp_matrix" && bad_evidence="$(mktemp)" && printf '{"format":"json"}' >"$bad_evidence" && ! ./scripts/update-compat-matrix.sh --matrix "$tmp_matrix" --evidence "$bad_evidence" --env-profile "Linux (baseline target profile)" --check-scope "install/shell/tmux/vim/docs parity" --caveat "not-observed" --command-ref "./scripts/verify-suite.sh --json" --date 2026-02-25 && broken_matrix="$(mktemp)" && sed 's/| Last Validated |/| Validation Date |/' .planning/compatibility/v1.1-matrix.md > "$broken_matrix" && good_evidence="$(mktemp)" && ./scripts/verify-suite.sh --json >"$good_evidence" && ! ./scripts/update-compat-matrix.sh --matrix "$broken_matrix" --evidence "$good_evidence" --env-profile "Linux (baseline target profile)" --check-scope "install/shell/tmux/vim/docs parity" --caveat "not-observed" --command-ref "./scripts/verify-suite.sh --json" --date 2026-02-25</verify>
  <done>Invalid evidence and schema mismatch paths are rejected deterministically and safely.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Evidence ingestion uses observed wrapper JSON only (`./scripts/verify-suite.sh --json`)
- [ ] Existing row updates are deterministic by key (`Environment Profile` + `Check Scope`)
- [ ] New row insertion for unseen keys works without duplicate-key drift
- [ ] Required matrix schema and status vocabulary validation is enforced
- [ ] Malformed evidence and malformed matrix schema fail fast with non-zero exits
- [ ] No out-of-scope capability work (`AUTO-06`, CI publishing, runtime feature-family changes) is introduced
</verification>

<success_criteria>

- `COMP-03` core automation exists and is executable from repo root
- Canonical matrix update flow is deterministic and evidence-backed
- Schema/provenance guards prevent silent corruption or inferred status claims

</success_criteria>

<output>
After completion, create `.planning/phases/08-compatibility-matrix-evidence-automation/08-01-SUMMARY.md`
</output>
